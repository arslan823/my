#!/bin/bash

# ...

# Цикл по протоколам
for PROTOCOL in "${PROTOCOLS[@]}"; do
    iptables -t nat -A PREROUTING -p $PROTOCOL -d $SOURCE_IP --dport $PORT -j DNAT --to-destination $DEST_IP:$PORT
    iptables -t nat -A POSTROUTING -p $PROTOCOL -m $PROTOCOL --dport $PORT -j SNAT --to-source $SOURCE_IP
done

# Проверка правил DNAT
if ! iptables -t nat -v -L PREROUTING -n --line-number | grep -q "DNAT.*udp.*$SOURCE_IP.*$PORT.*$DEST_IP:$PORT"; then
  echo "Ошибка: правило DNAT для udp не установлено."
  exit 1
fi

# Проверка правил SNAT
if ! iptables -t nat -v -L POSTROUTING -n --line-number | grep -q "SNAT.*udp.*$PORT.*$SOURCE_IP"; then
  echo "Ошибка: правило SNAT для udp не установлено."
  exit 1
fi

# ...

if [ $? -eq 0 ]; then
  echo "Правила iptables и sysctl успешно установлены и проверены."
else
  echo "Ошибка при установке или проверке правил. Правила не установлены."
  exit 1
fi
