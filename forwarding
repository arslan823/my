#!/bin/bash

# ...

# Получаем начальное количество правил
initial_prerouting_count=$(iptables -t nat -L PREROUTING -n -v --line-numbers | wc -l)
initial_postrouting_count=$(iptables -t nat -L POSTROUTING -n -v --line-numbers | wc -l)

# Цикл по протоколам
for PROTOCOL in "${PROTOCOLS[@]}"; do
    iptables -t nat -A PREROUTING -p $PROTOCOL -d $SOURCE_IP --dport $PORT -j DNAT --to-destination $DEST_IP:$PORT
    iptables -t nat -A POSTROUTING -p $PROTOCOL -m $PROTOCOL --dport $PORT -j SNAT --to-source $SOURCE_IP
done

# Получаем конечное количество правил
final_prerouting_count=$(iptables -t nat -L PREROUTING -n -v --line-numbers | wc -l)
final_postrouting_count=$(iptables -t nat -L POSTROUTING -n -v --line-numbers | wc -l)

# Проверка правил
if [ $final_prerouting_count -eq $initial_prerouting_count ] || [ $final_postrouting_count -eq $initial_postrouting_count ]; then
  echo "Ошибка: правила DNAT или SNAT не установлены."
  exit 1
fi

# ...

if [ $? -eq 0 ]; then
  echo "Правила iptables и sysctl успешно установлены и проверены."
else
  echo "Ошибка при установке или проверке правил. Правила не установлены."
  exit 1
fi
