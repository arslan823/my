#!/bin/bash

# Опция -F для сброса всех существующих правил
if [[ $1 == "-F" ]]; then
    iptables --policy INPUT   ACCEPT;
    iptables --policy OUTPUT  ACCEPT;
    iptables --policy FORWARD ACCEPT;
    iptables -F
    iptables -X
    iptables -Z
    iptables -t nat -F
    iptables -t nat -X
    iptables -t nat -Z
    iptables -t mangle -F
    iptables -t mangle -X
    iptables -t mangle -Z
    iptables -t raw -F
    iptables -t raw -X
    iptables -t raw -Z
    shift
fi

# Переменные
SOURCE_IP=$1
DEST_IP=$2
PORT=$3
shift 3

# Массив протоколов
PROTOCOLS=("$@")

# Установка правил
for PROTOCOL in "${PROTOCOLS[@]}"; do
    iptables -t nat -A PREROUTING -p $PROTOCOL -d $SOURCE_IP --dport $PORT -j DNAT --to-destination $DEST_IP:$PORT
    iptables -t nat -A POSTROUTING -p $PROTOCOL -m $PROTOCOL --dport $PORT -j SNAT --to-source $SOURCE_IP
done

# Проверка правил
ERROR=false
for PROTOCOL in "${PROTOCOLS[@]}"; do
    if ! iptables -t nat -C PREROUTING -p $PROTOCOL -d $SOURCE_IP --dport $PORT -j DNAT --to-destination $DEST_IP:$PORT; then
        echo "Ошибка: правило DNAT для $PROTOCOL не установлено."
        ERROR=true
    fi
    if ! iptables -t nat -C POSTROUTING -p $PROTOCOL -m $PROTOCOL --dport $PORT -j SNAT --to-source $SOURCE_IP; then
        echo "Ошибка: правило SNAT для $PROTOCOL не установлено."
        ERROR=true
    fi
done

if $ERROR; then
    echo "Проверьте введенные данные и повторите попытку."
    exit 1
fi

# Проверка наличия iptables-persistent и установка, если необходимо
if ! dpkg -l | grep -q "iptables-persistent"; then
    DEBIAN_FRONTEND=noninteractive apt install -y iptables-persistent
fi

# Сохранение правил
iptables-save > /etc/iptables/rules.v4

echo "Правила iptables и sysctl успешно установлены и проверены."
