#!/bin/bash

# Проверка наличия iptables
if ! command -v iptables &> /dev/null; then
    echo "iptables не найден. Установка..."
    DEBIAN_FRONTEND=noninteractive apt install -y iptables
fi

# Опция -F для сброса всех существующих правил
if [[ "$@" == *"-F"* ]]; then
    iptables -F
    iptables -X
    iptables -Z
    iptables -t nat -F
    iptables -t nat -X
    iptables -t nat -Z
    iptables -t mangle -F
    iptables -t mangle -X
    iptables -t mangle -Z
    iptables -t raw -F
    iptables -t raw -X
    iptables -t raw -Z
fi

# Переменные
SOURCE_IP=$1
DEST_IP=$2
PORT=$3
shift 3

# Массив протоколов
PROTOCOLS=("$@")

# Цикл по протоколам
for PROTOCOL in "${PROTOCOLS[@]}"; do
    iptables -t nat -A PREROUTING -p $PROTOCOL -d $SOURCE_IP --dport $PORT -j DNAT --to-destination $DEST_IP:$PORT
    iptables -t nat -A POSTROUTING -p $PROTOCOL -m $PROTOCOL --dport $PORT -j SNAT --to-source $SOURCE_IP
done

# Проверка и добавление правил в sysctl
if ! grep -q "net.core.default_qdisc = fq" /etc/sysctl.conf; then
    echo "net.core.default_qdisc = fq" >> /etc/sysctl.conf
fi

if ! grep -q "net.ipv4.tcp_congestion_control = bbr" /etc/sysctl.conf; then
    echo "net.ipv4.tcp_congestion_control = bbr" >> /etc/sysctl.conf
fi

if ! grep -q "net.ipv4.ip_forward = 1" /etc/sysctl.conf; then
    echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
fi

# Применение изменений
sysctl -p

# Проверка наличия iptables-persistent и установка, если необходимо
if ! dpkg -l | grep -q "iptables-persistent"; then
    DEBIAN_FRONTEND=noninteractive apt install -y iptables-persistent
fi

# Сохранение правил
iptables-save > /etc/iptables/rules.v4

echo "Правила iptables и sysctl успешно установлены"
