#!/bin/bash

# Опция -F для сброса всех существующих правил
if [[ $1 == "-F" ]]; then
    iptables --policy INPUT   ACCEPT;
    iptables --policy OUTPUT  ACCEPT;
    iptables --policy FORWARD ACCEPT;
    iptables -F
    iptables -X
    iptables -Z
    iptables -t nat -F
    iptables -t nat -X
    iptables -t nat -Z
    iptables -t mangle -F
    iptables -t mangle -X
    iptables -t mangle -Z
    iptables -t raw -F
    iptables -t raw -X
    iptables -t raw -Z
    shift
fi

# Проверка и добавление правил в sysctl
if ! grep -q "net.core.default_qdisc = fq" /etc/sysctl.conf; then
    echo "net.core.default_qdisc = fq" >> /etc/sysctl.conf
fi

if ! grep -q "net.ipv4.tcp_congestion_control = bbr" /etc/sysctl.conf; then
    echo "net.ipv4.tcp_congestion_control = bbr" >> /etc/sysctl.conf
fi

if ! grep -q "net.ipv4.ip_forward = 1" /etc/sysctl.conf; then
    echo "net.ipv4.ip_forward = 1" >> /etc/sysctl.conf
fi

# Применение изменений
sysctl -p

# Переменные
SOURCE_IP=$1
DEST_IP=$2
PORT=$3
PROTOCOL=$4

# Установка правил
iptables -t nat -A PREROUTING -d $SOURCE_IP/32 -p $PROTOCOL -m $PROTOCOL --dport $PORT -j DNAT --to-destination $DEST_IP:$PORT
iptables -t nat -A POSTROUTING -s $DEST_IP/32 -p $PROTOCOL -m $PROTOCOL --dport $PORT -j SNAT --to-source $SOURCE_IP

# Проверка правил
if ! iptables -t nat -C PREROUTING -d $SOURCE_IP/32 -p $PROTOCOL -m $PROTOCOL --dport $PORT -j DNAT --to-destination $DEST_IP:$PORT; then
    echo "Ошибка: правило DNAT для $PROTOCOL не установлено."
    exit 1
fi

if ! iptables -t nat -C POSTROUTING -s $DEST_IP/32 -p $PROTOCOL -m $PROTOCOL --dport $PORT -j SNAT --to-source $SOURCE_IP; then
    echo "Ошибка: правило SNAT для $PROTOCOL не установлено."
    exit 1
fi

echo "Правила iptables и sysctl успешно установлены и проверены."
